/**
 * @file Firestore Security Rules
 * @core_philosophy This ruleset enforces a user-centric security model.
 *  - Users can only manage their own profiles and contacts.
 *  - Chat access is restricted to participants.
 *  - Flexible data validation to allow rapid prototyping.
 * @data_structure
 *  - /users/{userId}: Stores user profiles.
 *  - /users/{userId}/contacts/{contactId}: Stores user contacts.
 *  - /chats/{chatId}: Stores chat metadata and participant information.
 *  - /chats/{chatId}/messages/{messageId}: Stores individual chat messages.
 * @key_security_decisions
 *  - Users can read any user profile.
 *  - Listing of users is allowed for any signed-in user.
 *  - Chat participant lists are central to chat security, so access is granted only to authenticated participants.
 *  - The `get()` call in the original rules for `chats/{chatId}/messages/{messageId}` has been removed and replaced with data denormalization in order to optimize the rules.
 * @denormalization_for_authorization
 *  - To avoid costly `get()` calls, we rely on the `participants` map being present on the `/chats/{chatId}` document. This allows for efficient authorization checks for both the chat document itself and its `/messages` subcollection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (get, list): Any authenticated user can read user profiles.
     * @allow (create, update, delete): Only the user with the matching userId can modify their own profile.
     * @deny (create, update, delete): Any other user attempting to modify another user's profile.
     * @principle Enforces document ownership for writes and open reads for authenticated users.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if request.auth.uid == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to a user's contacts.
     * @path /users/{userId}/contacts/{contactId}
     * @allow (read, write): Only the user with the matching userId can read or write their own contacts.
     * @deny (read, write): Any other user attempting to access another user's contacts.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/contacts/{contactId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && resource.data.userId == userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to chat documents.
     * @path /chats/{chatId}
     * @allow (read, write): Only participants of the chat can read or write to the chat document.
     * @deny (read, write): Users who are not participants of the chat.
     * @principle Enforces shared access (closed collaborators) based on the 'participants' map.
     */
    match /chats/{chatId} {
      allow get: if isParticipant(resource.data.participants);
      allow list: if false;
      allow create: if isParticipant(request.resource.data.participants);
      allow update: if isExistingParticipant(resource.data.participants);
      allow delete: if isExistingParticipant(resource.data.participants);
    }

    /**
     * @description Controls access to messages within a chat.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (read, write): Only participants of the chat can read or write messages in the chat.
     * @deny (read, write): Users who are not participants of the chat.
     * @principle Enforces shared access (closed collaborators) based on the parent chat's 'participants' map.
     */
    match /chats/{chatId}/messages/{messageId} {
      allow get: if isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
      allow list: if isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
      allow create: if isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants) && request.resource.data.chatId == chatId;
      allow update: if isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants) && request.resource.data.chatId == chatId;
      allow delete: if isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
    }

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isParticipant(participants) {
        return isSignedIn() && participants[request.auth.uid] == true;
    }

    function isExistingParticipant(participants) {
      return isParticipant(participants) && resource != null;
    }
  }
}