/**
 * @fileoverview Firestore Security Rules for Secure Talk application.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles and contacts.
 * Chats and messages within chats are secured based on the participants of the chat.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information.
 * - /chats/{chatId}: Stores chat session information.
 * - /chats/{chatId}/messages/{messageId}: Stores messages within a chat session.
 * - /users/{userId}/contacts/{contactId}: Stores contact information for a user.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profile data.
 * - Users can only manage their own contacts.
 * - Chat access is based on the `participants` array. If more granular roles are required, the `Chat` and `Message` schemas should be updated to include a `members` map (e.g., `members: {uid1: "role", uid2: "role"}`).
 *
 * Denormalization for Authorization:
 * - The `chats/{chatId}/messages/{messageId}` path includes the `chatId` on each message document. This enables efficient querying of messages belonging to a specific chat without needing to traverse user relationships, which is essential for Authorization Independence.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own profile.
     * @allow (get) User with ID 'user123' can read their own profile.
     * @allow (update) User with ID 'user123' can update their own profile.
     * @allow (delete) User with ID 'user123' can delete their own profile.
     * @deny (create) User with ID 'user456' cannot create a profile with ID 'user123'.
     * @deny (get) User with ID 'user456' cannot read user profile with ID 'user123'.
     * @deny (update) User with ID 'user456' cannot update user profile with ID 'user123'.
     * @deny (delete) User with ID 'user456' cannot delete user profile with ID 'user123'.
     * @principle Enforces document ownership for writes and reads.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to chat session information.
     * @path /chats/{chatId}
     * @allow (create) User who is a participant can create a chat.
     * @allow (get) User who is a participant can read a chat.
     * @allow (update) User who is a participant can update a chat (e.g., add participants).
     * @allow (delete) User who is a participant can delete a chat.
     * @deny (create) User who is not a participant cannot create a chat.
     * @deny (get) User who is not a participant cannot read a chat.
     * @deny (update) User who is not a participant cannot update a chat.
     * @deny (delete) User who is not a participant cannot delete a chat.
     * @principle Enforces access based on chat participants.
     */
    match /chats/{chatId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isParticipant() {
        return isSignedIn() && request.auth.uid in resource.data.participants;
      }

      function isCreatingValidChat() {
          return isSignedIn() && request.resource.data.participants.hasAll([request.auth.uid]);
      }

      allow get: if isParticipant();
      allow list: if isSignedIn();

      allow create: if isCreatingValidChat();
      allow update: if isParticipant();
      allow delete: if isParticipant();
    }

    /**
     * @description Controls access to messages within a chat session.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (create) User who is a participant of the chat can create a message.
     * @allow (get) User who is a participant of the chat can read a message.
     * @allow (update) No one can update a message after it's sent.
     * @allow (delete) No one can delete a message.
     * @deny (create) User who is not a participant cannot create a message.
     * @deny (get) User who is not a participant cannot read a message.
     * @deny (update) Any user (even participants) cannot update a message.
     * @deny (delete) Any user (even participants) cannot delete a message.
     * @principle Enforces access based on chat participants. Messages are immutable.
     */
    match /chats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isChatParticipant(chatId) {
        return get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      }

      allow get: if isSignedIn() && isChatParticipant(chatId);
      allow list: if isSignedIn() && isChatParticipant(chatId);

      allow create: if isSignedIn() && isChatParticipant(chatId);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to contact information for a user.
     * @path /users/{userId}/contacts/{contactId}
     * @allow (create) User with ID 'user123' can create a contact for themselves.
     * @allow (get) User with ID 'user123' can read their own contacts.
     * @allow (update) User with ID 'user123' can update their own contacts.
     * @allow (delete) User with ID 'user123' can delete their own contacts.
     * @deny (create) User with ID 'user456' cannot create a contact for user 'user123'.
     * @deny (get) User with ID 'user456' cannot read contacts for user 'user123'.
     * @deny (update) User with ID 'user456' cannot update contacts for user 'user123'.
     * @deny (delete) User with ID 'user456' cannot delete contacts for user 'user123'.
     * @principle Enforces document ownership for contacts.
     */
    match /users/{userId}/contacts/{contactId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }
  }
}