/**
 * @file Firestore Security Rules for Secure Talk application.
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for user profiles and contacts.
 *  Chat access is controlled through a participant list, allowing only listed users to read and write messages.
 *
 * @data_structure The data is organized hierarchically:
 *   - `/users/{userId}`: Stores user profile information, accessible only by the user themselves.
 *   - `/chats/{chatId}`: Stores chat session information.
 *   - `/chats/{chatId}/messages/{messageId}`: Stores messages within a chat session, accessible only to chat participants.
 *   - `/users/{userId}/contacts/{contactId}`: Stores contact information for a user, accessible only by the user themselves.
 *
 * @key_security_decisions
 *   - User listing is disallowed to protect user privacy.
 *   - Chat access is controlled via a `participants` map on the chat document. Only users listed in this map can read or write to the chat or its messages.
 *
 * @denormalization_for_authorization The `Message` entity does not require denormalization because its parent `Chat` entity already contains access control information.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (get) Authenticated user can read their own profile.
     * @allow (create) Authenticated user can create their own profile.
     * @allow (update) Authenticated user can update their own profile.
     * @allow (delete) Authenticated user can delete their own profile.
     * @deny (get) Authenticated user cannot read another user's profile.
     * @deny (create) Authenticated user cannot create a profile with a mismatched ID.
     * @deny (update) Authenticated user cannot update another user's profile.
     * @deny (delete) Authenticated user cannot delete another user's profile.
     * @principle Enforces document ownership for reads and writes.
     */
    match /users/{userId} {
      // Allow the user to read their own profile.
      allow get: if isSignedIn() && isOwner(userId);

      // Allow the user to create their own profile, but enforce that the ID matches the authenticated user's ID.
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;

      // Allow the user to update their own profile, but ensure that the ID remains immutable.
      allow update: if isSignedIn() && isExistingOwner(userId) && resource.data.id == request.resource.data.id;

      // Allow the user to delete their own profile.
      allow delete: if isSignedIn() && isExistingOwner(userId);

      // Disallow listing all users.
      allow list: if false;
    }

    /**
     * @description Controls access to chat session information.
     * @path /chats/{chatId}
     * @allow (get) Authenticated user who is a participant can read the chat.
     * @allow (create) Authenticated user can create a chat they are participating in.
     * @allow (update) Authenticated user who is a participant can update the chat.
     * @allow (delete) Authenticated user who is a participant can delete the chat.
     * @deny (get) Authenticated user who is not a participant cannot read the chat.
     * @deny (create) Authenticated user cannot create a chat they are not participating in.
     * @deny (update) Authenticated user who is not a participant cannot update the chat.
     * @deny (delete) Authenticated user who is not a participant cannot delete the chat.
     * @principle Enforces shared access based on the participants list.
     */
    match /chats/{chatId} {
      allow get: if isSignedIn() && isChatParticipant(chatId);
      allow create: if isSignedIn() && request.resource.data.participants[request.auth.uid] == true;
      allow update: if isSignedIn() && isExistingChatParticipant(chatId);
      allow delete: if isSignedIn() && isExistingChatParticipant(chatId);
      allow list: if false; // Listing chats not supported
    }

    /**
     * @description Controls access to messages within a chat session.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (get) Authenticated user who is a participant in the chat can read the message.
     * @allow (create) Authenticated user who is a participant in the chat can create a message.
     * @allow (update) Authenticated user who is a participant in the chat can update the message.
     * @allow (delete) Authenticated user who is a participant in the chat can delete the message.
     * @deny (get) Authenticated user who is not a participant in the chat cannot read the message.
     * @deny (create) Authenticated user who is not a participant in the chat cannot create a message.
     * @deny (update) Authenticated user who is not a participant in the chat cannot update the message.
     * @deny (delete) Authenticated user who is not a participant in the chat cannot delete the message.
     * @principle Enforces shared access to messages based on chat participants.
     */
    match /chats/{chatId}/messages/{messageId} {
      allow get: if isSignedIn() && isChatParticipant(chatId);
      allow create: if isSignedIn() && isChatParticipant(chatId);
      allow update: if isSignedIn() && isChatParticipant(chatId) && resource != null;
      allow delete: if isSignedIn() && isChatParticipant(chatId) && resource != null;
      allow list: if isSignedIn() && isChatParticipant(chatId);
    }

    /**
     * @description Controls access to contact information for a user.
     * @path /users/{userId}/contacts/{contactId}
     * @allow (get) Authenticated user can read their own contact.
     * @allow (create) Authenticated user can create their own contact.
     * @allow (update) Authenticated user can update their own contact.
     * @allow (delete) Authenticated user can delete their own contact.
     * @deny (get) Authenticated user cannot read another user's contact.
     * @deny (create) Authenticated user cannot create a contact with a mismatched user ID.
     * @deny (update) Authenticated user cannot update another user's contact.
     * @deny (delete) Authenticated user cannot delete another user's contact.
     * @principle Enforces document ownership for contacts.
     */
    match /users/{userId}/contacts/{contactId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isSignedIn() && isExistingOwner(userId) && resource.data.userId == request.resource.data.userId;
      allow delete: if isSignedIn() && isExistingOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
    }

    // --- Helper Functions ---

    // Returns true if the user is signed in.
    function isSignedIn() {
      return request.auth != null;
    }

    // Returns true if the authenticated user's ID matches the provided user ID.
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Returns true if the authenticated user's ID matches the provided user ID, and the document exists.
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    // Returns true if the authenticated user is a participant in the chat.
    function isChatParticipant(chatId) {
      return get(/databases/$(database)/documents/chats/$(chatId)).data.participants[request.auth.uid] == true;
    }

      // Returns true if the authenticated user is a participant in the chat and the chat exists.
    function isExistingChatParticipant(chatId) {
        return isChatParticipant(chatId) && resource != null;
    }
  }
}