/**
 * @fileoverview Firestore Security Rules for Secure Talk application.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for personal data and shared-access for chats.
 * All write operations are secured with authorization checks. Data shape validation is minimized for prototyping.
 *
 * Data Structure:
 * - User profiles are stored under /users/{userId}.
 * - Usernames are stored under /usernames/{username}.
 * - Team member profiles are stored under /team/{userId}.
 * - 1-on-1 chat sessions are stored under /chats/{chatId}, with messages in subcollections.
 * - User contacts are stored under /users/{userId}/contacts/{contactId}.
 * - Group chats are stored under /groups/{groupId}, with messages in subcollections.
 *
 * Key Security Decisions:
 * - Users can only read/write their own profile data.
 * - Usernames can be claimed once, and the claim is immutable.
 * - Chats are accessible to participants.
 * - Contacts are private to the owning user.
 * - Listing all users or chats is disallowed.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (create) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can create their own profile if request.auth.uid == userId
     * @allow (get) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can read their own profile.
     * @allow (update) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can update their own profile.
     * @allow (delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can delete their own profile.
     * @deny (create) User 'attackerId' cannot create a profile for 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2'.
     * @deny (get) User 'attackerId' cannot read the profile of 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2'.
     * @deny (update) User 'attackerId' cannot update the profile of 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2'.
     * @deny (delete) User 'attackerId' cannot delete the profile of 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Controls access to reserved usernames.
     * @path /databases/{database}/documents/usernames/{username}
     * @allow (create) User can claim a username if they are authenticated.
     * @allow (get) Anyone can check if a username is taken.
     * @deny (update) Username claims cannot be changed.
     * @deny (delete) Username claims cannot be deleted.
     * @deny (create) User 'attackerId' cannot create a username for 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2'.
     * @deny (update) User 'attackerId' cannot update a username for 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2'.
     * @deny (delete) User 'attackerId' cannot delete a username for 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2'.
     * @principle Enforces write-once ownership for usernames.
     */
    match /usernames/{username} {
      allow get: if true;
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to team member profiles.
     * @path /databases/{database}/documents/team/{userId}
     * @allow (get) Anyone can view team member profiles.
     * @deny (create) Only admins can create team member profiles. // TODO: Add admin role check
     * @deny (update) Only admins can update team member profiles. // TODO: Add admin role check
     * @deny (delete) Only admins can delete team member profiles. // TODO: Add admin role check
     * @principle Restricts write access to administrators (TODO).
     */
    match /team/{userId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add admin role check
      allow update: if false; // TODO: Add admin role check
      allow delete: if false; // TODO: Add admin role check
    }

    /**
     * @description Controls access to 1-on-1 chat sessions.
     * @path /databases/{database}/documents/chats/{chatId}
     * @allow (get) Participants can read chat details.
     * @allow (create) Users can create a chat if they are a participant.
     * @allow (update) Participants can update chat metadata (e.g., typing status).
     * @deny (delete) Only admins can delete chats. // TODO: Add admin role check
     * @deny (create) User 'attackerId' cannot create a chat for 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2'.
     * @deny (get) User 'attackerId' cannot get a chat for 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2'.
     * @deny (update) User 'attackerId' cannot update a chat for 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2'.
     * @principle Enforces shared access for chat participants.
     */
    match /chats/{chatId} {
      allow get: if isSignedIn() && resource.data.participants[request.auth.uid] == true;
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.participants[request.auth.uid] == true;
      allow update: if isSignedIn() && resource.data.participants[request.auth.uid] == true;
      allow delete: if false; // TODO: Add admin role check

      /**
       * @description Controls access to messages within a 1-on-1 chat session.
       * @path /databases/{database}/documents/chats/{chatId}/messages/{messageId}
       * @allow (create) Participants can create messages.
       * @allow (get) Participants can read messages.
       * @deny (update) Messages cannot be updated.
       * @deny (delete) Messages cannot be deleted.
       * @principle Enforces shared access for chat participants; messages are immutable.
       */
      match /messages/{messageId} {
        allow get: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants[request.auth.uid] == true;
        allow list: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants[request.auth.uid] == true;
        allow create: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants[request.auth.uid] == true;
        allow update: if false;
        allow delete: if false;
      }
    }

    /**
     * @description Controls access to a user's contact list.
     * @path /databases/{database}/documents/users/{userId}/contacts/{contactId}
     * @allow (create) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can add contacts to their own list.
     * @allow (get) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can read their own contact list.
     * @allow (update) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can update contacts in their own list.
     * @allow (delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can delete contacts from their own list.
     * @deny (create) User 'attackerId' cannot create contacts for 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2'.
     * @deny (get) User 'attackerId' cannot get contacts for 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2'.
     * @deny (update) User 'attackerId' cannot update contacts for 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2'.
     * @deny (delete) User 'attackerId' cannot delete contacts for 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2'.
     * @principle Restricts access to a user's own contact data.
     */
    match /users/{userId}/contacts/{contactId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.userId == userId;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Controls access to group chat sessions.
     * @path /databases/{database}/documents/groups/{groupId}
     * @allow (get) Participants can read group chat details.
     * @allow (create) Group can be created if the user is the owner
     * @allow (update) Participants can update group chat metadata (e.g., typing status).
     * @deny (delete) Only admins can delete groups. // TODO: Add admin role check
     *
     * @principle Enforces shared access for group participants.
     */
    match /groups/{groupId} {
      allow get: if isSignedIn() && resource.data.participants[request.auth.uid] == true;
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.participants[request.auth.uid] == true;
      allow delete: if false; // TODO: Add admin role check

      /**
       * @description Controls access to messages within a group chat session.
       * @path /databases/{database}/documents/groups/{groupId}/messages/{messageId}
       * @allow (create) Participants can create messages.
       * @allow (get) Participants can read messages.
       * @deny (update) Messages cannot be updated.
       * @deny (delete) Messages cannot be deleted.
       * @principle Enforces shared access for chat participants; messages are immutable.
       */
      match /messages/{messageId} {
        allow get: if isSignedIn() && get(/databases/$(database)/documents/groups/$(groupId)).data.participants[request.auth.uid] == true;
        allow list: if isSignedIn() && get(/databases/$(database)/documents/groups/$(groupId)).data.participants[request.auth.uid] == true;
        allow create: if isSignedIn() && get(/databases/$(database)/documents/groups/$(groupId)).data.participants[request.auth.uid] == true;
        allow update: if false;
        allow delete: if false;
      }
    }
  }

  // --- Helper Functions ---

  /**
   * @description Checks if the user is signed in.
   * @return {boolean} True if the user is authenticated.
   */
  function isSignedIn() {
    return request.auth != null;
  }

  /**
   * @description Checks if the user is the owner of the resource.
   * @param {string} userId - The user ID to compare against the request's auth UID.
   * @return {boolean} True if the user is the owner.
   */
  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  /**
   * @description Checks if the user is the owner of the existing resource.
   * @param {string} userId - The user ID to compare against the resource's userId.
   * @return {boolean} True if the user is the owner and the resource exists.
   */
  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}