/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for most data,
 *              allowing users to read and write their own data. It also supports
 *              shared access for chats and groups, where participants can read and write
 *              messages.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles. Accessible only to the user.
 * - /usernames/{username}: Stores reserved usernames. World-readable, owner-writeable.
 * - /team/{teamMemberId}: Stores team member profiles. World-readable, owner-writeable.
 * - /chats/{chatId}: Stores chat metadata. Accessible to chat participants.
 * - /chats/{chatId}/messages/{messageId}: Stores chat messages. Accessible to chat participants.
 * - /users/{userId}/contacts/{contactId}: Stores user contacts. Accessible only to the user.
 * - /groups/{groupId}: Stores group chat metadata. Accessible to group participants.
 * - /groups/{groupId}/messages/{messageId}: Stores group messages. Accessible to group participants.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - The rules do not validate the internal structure of the data being written,
 *   focusing instead on authorization and relational integrity.
 * - `usernames` and `team` collection data are world-readable, but only the owning user can modify.
 * - Access to chats and groups is determined by the `participants` map on each document.
 *
 * Denormalization for Authorization:
 * - The `chats` and `groups` documents denormalize the list of participants directly on the document
 *   using a map (e.g., `{ participants: { 'user_abc': true, 'user_xyz': true } }`). This allows
 *   rules to quickly check if a user is a participant without additional reads.
 *
 * Structural Segregation:
 * - N/A
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages access to user profile information.
     * @path /users/{userId}
     * @allow (get, list) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can read their own profile.
     * @allow (create) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can create their own profile.
     * @allow (update, delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can update/delete their own profile.
     * @deny (get, list) User 'anotherUser' cannot read another user's profile.
     * @deny (create, update, delete) User 'anotherUser' cannot create/update/delete another user's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      // Helper function to check if the request is from the owner
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      // Allow the user to read their own profile
      allow get: if isOwner(userId);

      // Allow the user to list their own profile (not applicable but included for completeness)
      allow list: if false;

      // Allow the user to create their own profile, validating the user ID
      allow create: if isOwner(userId);

      // Allow the user to update their own profile
      allow update: if isOwner(userId);

      // Allow the user to delete their own profile
      allow delete: if isOwner(userId);
    }

    /**
     * @description Manages access to the collection of usernames.
     * @path /usernames/{username}
     * @allow (get, list) Any user can read a username.
     * @allow (create) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can create a username if they own it.
     * @allow (update, delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can update/delete a username if they own it.
     * @deny (create, update, delete) User 'anotherUser' cannot create/update/delete a username they don't own.
     * @principle Enforces document ownership for writes, allows public reads.
     */
    match /usernames/{username} {
      // Helper function to check if the request is from the owner
      function isOwner() {
        return request.auth != null && request.auth.uid == resource.data.userId;
      }

      // Allow anyone to read usernames
      allow get, list: if true;

      // Allow the user to create a username, validating ownership
      allow create: if request.auth.uid == request.resource.data.userId;

      // Allow the user to update the username, validating ownership
      allow update: if isOwner();

      // Allow the user to delete the username, validating ownership
      allow delete: if isOwner();
    }

    /**
     * @description Manages access to team member profiles.
     * @path /team/{teamMemberId}
     * @allow (get, list) Any user can read team member profiles.
     * @allow (create) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can create a team member profile if they own it.
     * @allow (update, delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can update/delete a team member profile if they own it.
     * @deny (create, update, delete) User 'anotherUser' cannot create/update/delete a team member profile they don't own.
     * @principle Enforces document ownership for writes, allows public reads.
     */
    match /team/{teamMemberId} {
      // Helper function to check if the request is from the owner
      function isOwner() {
        return request.auth != null && request.auth.uid == resource.data.userId;
      }

      // Allow anyone to read team member profiles
      allow get, list: if true;

      // Allow the user to create a team member profile, validating ownership
      allow create: if request.auth.uid == request.resource.data.userId;

      // Allow the user to update the team member profile, validating ownership
      allow update: if isOwner();

      // Allow the user to delete the team member profile, validating ownership
      allow delete: if isOwner();
    }

    /**
     * @description Manages access to chat sessions.
     * @path /chats/{chatId}
     * @allow (get, list) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can read a chat if they are a participant.
     * @allow (create) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can create a chat if they are a participant.
     * @allow (update, delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can update/delete a chat if they are a participant.
     * @deny (get, list) User 'anotherUser' cannot read a chat if they are not a participant.
     * @deny (create, update, delete) User 'anotherUser' cannot create/update/delete a chat if they are not a participant.
     * @principle Enforces shared access based on the participants map.
     */
    match /chats/{chatId} {
      // Helper function to check if the user is a participant
      function isParticipant() {
        return request.auth != null && resource.data.participants[request.auth.uid] == true;
      }

       function isCreatingParticipant() {
        return request.auth != null && request.resource.data.participants[request.auth.uid] == true;
      }

      // Allow participants to read the chat
      allow get, list: if isParticipant();

      // Allow creating a chat if the user is a participant
      allow create: if isCreatingParticipant();

      // Allow participants to update the chat
      allow update: if isCreatingParticipant();

      // Allow participants to delete the chat
      allow delete: if isCreatingParticipant();
    }

    /**
     * @description Manages access to messages within a chat session.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (get, list) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can read a message if they are a participant in the chat.
     * @allow (create) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can create a message if they are a participant in the chat.
     * @allow (update, delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can update/delete a message if they are a participant in the chat.
     * @deny (get, list) User 'anotherUser' cannot read a message if they are not a participant in the chat.
     * @deny (create, update, delete) User 'anotherUser' cannot create/update/delete a message if they are not a participant in the chat.
     * @principle Enforces shared access based on the parent chat's participants.
     */
    match /chats/{chatId}/messages/{messageId} {
      // Helper function to check if the user is a participant in the parent chat
      function isParticipant(chatId) {
        return request.auth != null && get(/databases/$(database)/documents/chats/$(chatId)).data.participants[request.auth.uid] == true;
      }

      // Allow participants to read messages
      allow get, list: if isParticipant(chatId);

      // Allow participants to create messages
      allow create: if isParticipant(chatId);

      // Allow participants to update messages
      allow update: if isParticipant(chatId);

      // Allow participants to delete messages
      allow delete: if isParticipant(chatId);
    }

    /**
     * @description Manages access to a user's contact list.
     * @path /users/{userId}/contacts/{contactId}
     * @allow (get, list) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can read their own contacts.
     * @allow (create) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can create a contact for themselves.
     * @allow (update, delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can update/delete a contact for themselves.
     * @deny (get, list) User 'anotherUser' cannot read another user's contacts.
     * @deny (create, update, delete) User 'anotherUser' cannot create/update/delete another user's contacts.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/contacts/{contactId} {
      // Helper function to check if the request is from the owner
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      // Allow the user to read their own contacts
      allow get: if isOwner(userId);

      // Allow the user to list their own contacts
      allow list: if false;

      // Allow the user to create a contact, validating ownership
      allow create: if isOwner(userId);

      // Allow the user to update their own contact, validating ownership
      allow update: if isOwner(userId);

      // Allow the user to delete their own contact
      allow delete: if isOwner(userId);
    }

    /**
     * @description Manages access to group chat sessions.
     * @path /groups/{groupId}
     * @allow (get, list) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can read a group if they are a participant.
     * @allow (create) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can create a group if they are a participant.
     * @allow (update, delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can update/delete a group if they are a participant.
     * @deny (get, list) User 'anotherUser' cannot read a group if they are not a participant.
     * @deny (create, update, delete) User 'anotherUser' cannot create/update/delete a group if they are not a participant.
     * @principle Enforces shared access based on the participants map.
     */
    match /groups/{groupId} {
      // Helper function to check if the user is a participant
      function isParticipant() {
        return request.auth != null && resource.data.participants[request.auth.uid] == true;
      }

       function isCreatingParticipant() {
        return request.auth != null && request.resource.data.participants[request.auth.uid] == true;
      }

      // Allow participants to read the group
      allow get, list: if isParticipant();

      // Allow creating a group if the user is a participant
      allow create: if isCreatingParticipant();

      // Allow participants to update the group
      allow update: if isCreatingParticipant();

      // Allow participants to delete the group
      allow delete: if isCreatingParticipant();
    }

    /**
     * @description Manages access to messages within a group chat session.
     * @path /groups/{groupId}/messages/{messageId}
     * @allow (get, list) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can read a message if they are a participant in the group.
     * @allow (create) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can create a message if they are a participant in the group.
     * @allow (update, delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can update/delete a message if they are a participant in the group.
     * @deny (get, list) User 'anotherUser' cannot read a message if they are not a participant in the group.
     * @deny (create, update, delete) User 'anotherUser' cannot create/update/delete a message if they are not a participant in the group.
     * @principle Enforces shared access based on the parent group's participants.
     */
    match /groups/{groupId}/messages/{messageId} {
      // Helper function to check if the user is a participant in the parent group
      function isParticipant(groupId) {
        return request.auth != null && get(/databases/$(database)/documents/groups/$(groupId)).data.participants[request.auth.uid] == true;
      }

      // Allow participants to read messages
      allow get, list: if isParticipant(groupId);

      // Allow participants to create messages
      allow create: if isParticipant(groupId);

      // Allow participants to update messages
      allow update: if isParticipant(groupId);

      // Allow participants to delete messages
      allow delete: if isParticipant(groupId);
    }

      /**
       * @description Manages access to team members in admin panel.
       * @path /admin/team
       * @allow get, list: if true
       * @allow create, update, delete: if false
       * @principle Allows only read operation
       */
       match /admin/team/{document} {
            allow get, list: if true;
            allow create, update, delete: if false;
       }
  }
}