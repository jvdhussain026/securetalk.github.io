rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles. Only the user can read/write their own profile.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (get, create, update, delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can access their own profile.
     * @deny (get, create, update, delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' cannot access another user's profile ('3bX2voPdZHOhFGXAp1EjByd9j9l1').
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Secure chat sessions. Access is granted to members of the chat.
     * @path /databases/{database}/documents/chats/{chatId}
     * @allow (get, create, update, delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can access a chat if they are a participant.
     * @deny (get, create, update, delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' cannot access a chat if they are not a participant.
     * @principle Enforces shared access based on the 'participants' array.
     */
    match /chats/{chatId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isParticipant() {
        return request.auth.uid in resource.data.participants;
      }

      allow get: if isSignedIn() && resource.data.participants is list && request.auth.uid in resource.data.participants;
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.participants is list && request.auth.uid in request.resource.data.participants;
      allow update: if isSignedIn() && resource.data.participants is list && request.auth.uid in resource.data.participants;
      allow delete: if isSignedIn() && resource.data.participants is list && request.auth.uid in resource.data.participants;
    }

    /**
     * @description Secure messages within a chat session. Access is granted to members of the chat.
     * @path /databases/{database}/documents/chats/{chatId}/messages/{messageId}
     * @allow (get, create, update, delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can access a message if they are a participant in the chat.
     * @deny (get, create, update, delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' cannot access a message if they are not a participant in the chat.
     * @principle Enforces shared access to messages based on chat membership.
     */
    match /chats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isChatParticipant(chatId) {
        return get(/databases/$(database)/documents/chats/$(chatId)).data.participants is list && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }

      allow get: if isSignedIn() && isChatParticipant(chatId);
      allow list: if isSignedIn() && isChatParticipant(chatId);
      allow create: if isSignedIn() && isChatParticipant(chatId);
      allow update: if isSignedIn() && isChatParticipant(chatId);
      allow delete: if isSignedIn() && isChatParticipant(chatId);
    }

    /**
     * @description Secure contact information for a user. Only the user can read/write their own contacts.
     * @path /databases/{database}/documents/users/{userId}/contacts/{contactId}
     * @allow (get, create, update, delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can access their own contact.
     * @deny (get, create, update, delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' cannot access another user's contact.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/contacts/{contactId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }
  }
}