/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user profiles and contacts.
 *  Chat and messages are secured based on chat participants.
 * @dataStructure
 *  - /users/{userId}: Stores user profile information.
 *  - /chats/{chatId}: Stores chat session information.
 *  - /chats/{chatId}/messages/{messageId}: Stores messages within a chat session.
 *  - /users/{userId}/contacts/{contactId}: Stores contact information for a user.
 * @keySecurityDecisions
 *  - Users can only read and write their own profile data.
 *  - Contacts are private to each user and stored in a subcollection under their profile.
 *  - Chats and Messages are secured via a participants array of UIDs
 *  - The rules explicitly deny listing all users.
 * @denormalizationForAuthorization
 *  - The 'userId' is included within the contact document for direct ownership verification.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the requesting user is signed in.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the requesting user is the owner of the resource.
     * @param {string} userId The user ID to compare against the request's auth UID.
     * @return {bool} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the requesting user is the existing owner of the resource.
     * @param {string} userId The user ID to compare against the request's auth UID.
     * @return {bool} True if the user is the owner, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the requesting user is in the chat participants.
     * @return {bool} True if the user is in the chat participants, false otherwise.
     */
    function isInChatParticipants(participants) {
      return isSignedIn() && participants is list && request.auth.uid in participants;
    }

    /**
     * @description Rule for user documents.
     * @path /users/{userId}
     * @allow (get) Signed-in user can read their own profile data.
     * @allow (create) Signed-in user can create their own profile.
     * @allow (update) Signed-in user can update their own profile data.
     * @allow (delete) Signed-in user can delete their own profile data.
     * @deny (get) Signed-in user cannot read other user profile data.
     * @deny (create) Signed-in user cannot create other user profile.
     * @deny (update) Signed-in user cannot update other user profile data.
     * @deny (delete) Signed-in user cannot delete other user profile data.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for chat documents.
     * @path /chats/{chatId}
     * @allow (get) Signed-in user can read the chat data if they are a participant.
     * @allow (create) Signed-in user can create a chat if they are a participant.
     * @allow (update) Signed-in user can update the chat data if they are a participant.
     * @allow (delete) Signed-in user can delete the chat if they are a participant.
     * @deny (get) Signed-in user cannot read the chat data if they are not a participant.
     * @deny (create) Signed-in user cannot create a chat if they are not a participant.
     * @deny (update) Signed-in user cannot update the chat data if they are not a participant.
     * @deny (delete) Signed-in user cannot delete the chat if they are not a participant.
     * @principle Enforces chat access based on participants.
     */
    match /chats/{chatId} {
      allow get: if isInChatParticipants(resource.data.participants);
      allow list: if false; // Listing all chats is not allowed.
      allow create: if isSignedIn() && request.resource.data.participants is list && request.auth.uid in request.resource.data.participants;
      allow update: if isInChatParticipants(resource.data.participants);
      allow delete: if isInChatParticipants(resource.data.participants);
    }

    /**
     * @description Rule for message documents.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (get) Signed-in user can read the message data if they are a participant in the chat.
     * @allow (create) Signed-in user can create a message if they are a participant in the chat.
     * @allow (update) Signed-in user can update the message data if they are a participant in the chat.
     * @allow (delete) Signed-in user can delete the message if they are a participant in the chat.
     * @deny (get) Signed-in user cannot read the message data if they are not a participant in the chat.
     * @deny (create) Signed-in user cannot create a message if they are not a participant in the chat.
     * @deny (update) Signed-in user cannot update the message data if they are not a participant in the chat.
     * @deny (delete) Signed-in user cannot delete the message if they are not a participant in the chat.
     * @principle Enforces message access based on chat participation.
     */
    match /chats/{chatId}/messages/{messageId} {
      allow get: if isInChatParticipants(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.chatId == chatId && isInChatParticipants(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
      allow update: if isInChatParticipants(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
      allow delete: if isInChatParticipants(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
    }

    /**
     * @description Rule for contact documents.
     * @path /users/{userId}/contacts/{contactId}
     * @allow (get) Signed-in user can read their own contact data.
     * @allow (create) Signed-in user can create a contact in their contact list.
     * @allow (update) Signed-in user can update their own contact data.
     * @allow (delete) Signed-in user can delete their own contact data.
     * @deny (get) Signed-in user cannot read other user contact data.
     * @deny (create) Signed-in user cannot create contact in other user contact list.
     * @deny (update) Signed-in user cannot update other user contact data.
     * @deny (delete) Signed-in user cannot delete other user contact data.
     * @principle Enforces contact ownership for all operations.
     */
    match /users/{userId}/contacts/{contactId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}