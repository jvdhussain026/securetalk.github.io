/**
 * @file Firestore Security Rules for Secure Talk application.
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for user-specific data
 *   (e.g., contacts) and a shared access model for collaborative data (chats and messages).
 *   It prioritizes Authorization Independence by denormalizing authorization data directly
 *   onto documents, avoiding costly and complex `get()` calls in rules. Structural
 *   Segregation is used to maintain homogeneous security postures within collections.
 *
 * @data_structure
 *   - /users/{userId}: Stores user profile information. Only the user can read/write their own profile.
 *   - /chats/{chatId}: Stores chat session information. Access is controlled via a participants list.
 *   - /chats/{chatId}/messages/{messageId}: Stores messages within a chat session. Access is controlled by chat participants.
 *   - /users/{userId}/contacts/{contactId}: Stores contact information for a user. Only the user can manage their own contacts.
 *
 * @key_security_decisions
 *   - User listing is disallowed to protect user privacy.
 *   - All write operations are protected by authorization checks to ensure only authorized users can modify data.
 *
 * @denormalization_for_authorization
 *   - The `chats` documents contain a `participants` array that is used to authorize access to the chat and its messages.
 *   - The `contacts` documents contain a `userId` field that is used to authorize access to the contact.
 *
 * @structural_segregation
 *   - User-specific data (contacts) are stored under `/users/{userId}/contacts/{contactId}` to simplify ownership-based security rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Prevents unauthenticated access.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the resource.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an existing owner of the resource.
     *
     * This helper is for destructive operations such as `update` and `delete`. It combines
     * the ownership check with the existence check to prevent accidental omissions.
     */
    function isExistingOwner(userId) {
        return (isOwner(userId) && resource != null);
    }

    /**
     * @description Checks if the user is a participant in the chat.
     */
    function isChatParticipant(participantIds) {
      return isSignedIn() && participantIds.hasAny([request.auth.uid]);
    }

    /**
     * @description Defines a user document.
     * @path /users/{userId}
     * @allow (get) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can read their own profile data.
     * @allow (create) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can create their own profile document.
     * @allow (update) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can update their own profile data.
     * @allow (delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can delete their own profile data.
     * @deny (get) User 'otherUserId' cannot read User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' profile data.
     * @deny (create) User 'otherUserId' cannot create User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' profile data.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // User listing is disallowed.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Defines a chat document.
     * @path /chats/{chatId}
     * @allow (get) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can read the chat data if they are a participant.
     * @allow (create) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can create a chat if participants include the user.
     * @allow (update) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can update the chat data if they are a participant.
     * @allow (delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can delete the chat data if they are a participant.
     * @deny (get) User 'otherUserId' cannot read Chat 'chatId' data if they are not a participant.
     * @deny (create) User 'otherUserId' cannot create Chat 'chatId' data if they are not a participant.
     * @principle Enforces shared access for chat participants.
     */
    match /chats/{chatId} {
      allow get: if isChatParticipant(resource.data.participants);
      allow list: if true; // Public listing is allowed for chats.
      allow create: if isSignedIn() && request.resource.data.participants.hasAny([request.auth.uid]);
      allow update: if isSignedIn() && resource != null && resource.data.participants.hasAny([request.auth.uid]);
      allow delete: if isSignedIn() && resource != null && resource.data.participants.hasAny([request.auth.uid]);
    }

    /**
     * @description Defines a message document within a chat.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (get) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can read the message if they are a participant in the chat.
     * @allow (create) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can create a message if they are a participant in the chat.
     * @allow (update) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can update the message if they are a participant in the chat.
     * @allow (delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can delete the message if they are a participant in the chat.
     * @deny (get) User 'otherUserId' cannot read Message 'messageId' data if they are not a participant in the chat.
     * @deny (create) User 'otherUserId' cannot create Message 'messageId' data if they are not a participant in the chat.
     * @principle Enforces shared access for chat participants for messages.
     */
    match /chats/{chatId}/messages/{messageId} {
      allow get: if get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      allow list: if get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      allow create: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      allow update: if isSignedIn() && resource != null && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      allow delete: if isSignedIn() && resource != null && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
    }

    /**
     * @description Defines a contact document within a user's contact list.
     * @path /users/{userId}/contacts/{contactId}
     * @allow (get) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can read their own contact data.
     * @allow (create) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can create a contact in their contact list.
     * @allow (update) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can update a contact in their contact list.
     * @allow (delete) User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' can delete a contact in their contact list.
     * @deny (get) User 'otherUserId' cannot read User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' contact data.
     * @deny (create) User 'otherUserId' cannot create User 'Ysf0cXtN8zTxbqhmSjaUBSAz21v2' contact data.
     * @principle Enforces document ownership for all operations on contacts.
     */
    match /users/{userId}/contacts/{contactId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }
  }
}