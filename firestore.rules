/**
 * @file Firebase Security Rules for Secure Talk Application
 *
 * @description This ruleset enforces a strict user-ownership model for user profiles and contacts,
 * and a shared-access model for chats and messages.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information, accessible only to the user themselves.
 * - /users/{userId}/contacts/{contactId}: Stores contacts for a specific user, accessible only to that user.
 * - /chats/{chatId}: Stores chat session information, accessible to participants.
 * - /chats/{chatId}/messages/{messageId}: Stores messages within a chat session, accessible to participants.
 *
 * Key Security Decisions:
 * - Users can only access their own profile data and contacts.
 * - Chat access is based on participant membership, verified by checking if the user's UID is in the chat's participants array.
 * - Listing of contacts is allowed only for the owner of the contacts.
 * - In the rules below, there is no timestamp validation or complex data-type validation.
 *   Timestamps could be validated on the server side or within client-side validation logic.
 *   In this prototype mode, the application trusts the incoming data's basic structure.
 *
 * Denormalization for Authorization:
 * - The `chats` documents contain an array of `participants`, eliminating the need for complex `get()` calls to determine chat membership.
 * - The `messages` documents live under the `chats/{chatId}` documents, and inherit the participant authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (read, write) Authenticated user can access their own profile (create, update, get, delete).
     * @deny (read, write) Authenticated user cannot access other user's profiles.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // User listing is disabled for privacy.
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to contacts for a specific user.
     * @path /databases/{database}/documents/users/{userId}/contacts/{contactId}
     * @allow (create, update, get, delete) Authenticated user can manage their own contacts.
     * @deny (create, update, get, delete) Authenticated user cannot manage other user's contacts.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/contacts/{contactId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to chat sessions.
     * @path /databases/{database}/documents/chats/{chatId}
     * @allow (read) Any authenticated user can read chat session data if they are a participant.
     * @allow (write) Only participants can create, update, or delete chat sessions.
     * @deny (read, write) Users who are not participants cannot access chat sessions.
     * @principle Enforces shared access based on membership in the chat's participants array.
     */
    match /chats/{chatId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isParticipant() {
        return isSignedIn() && resource.data.participants.hasAny([request.auth.uid]);
      }
       
      function isCreatingParticipant() {
        return isSignedIn() && request.resource.data.participants.hasAny([request.auth.uid]);
      }

      allow get: if isParticipant(); // Require auth
      allow list: if false; // Disable listing
      allow create: if isCreatingParticipant();
      allow update: if isParticipant();
      allow delete: if isParticipant();
    }

    /**
     * @description Controls access to messages within a chat session.
     * @path /databases/{database}/documents/chats/{chatId}/messages/{messageId}
     * @allow (read) Any authenticated user can read messages if they are a participant in the chat.
     * @allow (create) Any authenticated user can create messages if they are a participant in the chat.
     * @deny (read, write) Users who are not participants cannot access messages.
     * @principle Enforces shared access based on membership in the parent chat's participants array.
     */
    match /chats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isChatParticipant(chatId) {
        return get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      }

      allow get: if isSignedIn() && isChatParticipant(chatId);
      allow list: if false; // Listing is disabled
      allow create: if isSignedIn() && isChatParticipant(chatId);
      allow update: if false; // Messages cannot be updated.
      allow delete: if false; // Messages cannot be deleted.
    }
  }
}