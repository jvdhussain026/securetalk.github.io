rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles.
     * @path /users/{userId}
     * @allow (create) Authenticated user can create their own profile.
     * @allow (get, update, delete) Authenticated user can read, update, and delete their own profile.
     * @deny (create) User cannot create a profile for another user.
     * @deny (get, update, delete) User cannot read, update, or delete another user's profile.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Secure reserved usernames.
     * @path /usernames/{username}
     * @allow (create) Any authenticated user can reserve a username.
     * @allow (get, update, delete) Only the owner of a username can read, update, or delete it.
     * @deny (update, delete) User cannot modify or delete another user's reserved username.
     * @principle Enforces ownership for username management.
     */
    match /usernames/{username} {
        function isOwner() {
            return request.auth.uid == resource.data.uid;
        }
        function isSignedIn() {
            return request.auth != null;
        }

        allow get: if isSignedIn() && isOwner();
        allow list: if false;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && isOwner();
        allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Secure team member profiles.
     * @path /team/{userId}
     * @allow (get, list) Public read access for team member profiles.
     * @deny (create, update, delete) Only authenticated users can create, update, or delete team member profiles.
     * @principle Provides public information while restricting modification.
     */
    match /team/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Secure 1-on-1 chat sessions.
     * @path /chats/{chatId}
     * @allow (get, list) Users can read chat sessions they participate in.
     * @allow (create) Users can create new chat sessions if they are a participant.
     * @allow (update) Users can update chat sessions if they are a participant.
     * @allow (delete) Users can delete chat sessions they participate in.
     * @deny (get, list, create, update, delete) Users cannot access chat sessions they are not a participant in.
     * @principle Enforces access based on chat participation.
     */
    match /chats/{chatId} {
        function isSignedIn() {
            return request.auth != null;
        }
        function isParticipant() {
            return request.auth.uid in resource.data.participants;
        }

        allow get: if isSignedIn() && isParticipant();
        allow list: if isSignedIn();
        allow create: if isSignedIn() && request.resource.data.participants[request.auth.uid] == true;
        allow update: if isSignedIn() && isParticipant();
        allow delete: if isSignedIn() && isParticipant();
    }

    /**
     * @description Secure messages within 1-on-1 chat sessions.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (get, list) Users can read messages in chat sessions they participate in.
     * @allow (create) Users can create messages in chat sessions they participate in.
     * @deny (get, list, create, update, delete) Users cannot access messages in chat sessions they are not a participant in.
     * @principle Enforces access based on chat participation.
     */
    match /chats/{chatId}/messages/{messageId} {
        function isSignedIn() {
            return request.auth != null;
        }
        function isChatParticipant(chatId) {
            return get(/databases/$(database)/documents/chats/$(chatId)).data.participants[request.auth.uid] == true;
        }

        allow get: if isSignedIn() && isChatParticipant(chatId);
        allow list: if isSignedIn() && isChatParticipant(chatId);
        allow create: if isSignedIn() && isChatParticipant(chatId);
        allow update: if false;
        allow delete: if false;
    }

    /**
     * @description Secure user contacts.
     * @path /users/{userId}/contacts/{contactId}
     * @allow (get, list) Users can read their own contacts.
     * @allow (create, update, delete) Users can create, update, and delete their own contacts.
     * @deny (get, list, create, update, delete) Users cannot access other users' contacts.
     * @principle Enforces document ownership for contact management.
     */
    match /users/{userId}/contacts/{contactId} {
        function isOwner(userId) {
            return request.auth.uid == userId;
        }
        function isSignedIn() {
            return request.auth != null;
        }

        allow get: if isSignedIn() && isOwner(userId);
        allow list: if isSignedIn() && isOwner(userId);
        allow create: if isSignedIn() && isOwner(userId);
        allow update: if isSignedIn() && isOwner(userId);
        allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Secure group chats.
     * @path /groups/{groupId}
     * @allow (get, list) Users can read group chats they participate in.
     * @allow (create) Users can create group chats.
     * @allow (update) Users can update group chats if they are the owner or a participant.
     * @allow (delete) Only the owner can delete a group chat.
     * @deny (get, list, create, update, delete) Users cannot access group chats they are not a participant in.
     * @principle Enforces access based on group membership and ownership.
     */
    match /groups/{groupId} {
        function isSignedIn() {
            return request.auth != null;
        }
        function isParticipant() {
            return request.auth.uid in resource.data.participants;
        }
        function isOwner() {
            return request.auth.uid == resource.data.ownerId;
        }

        allow get: if isSignedIn() && isParticipant();
        allow list: if isSignedIn();
        allow create: if isSignedIn() && request.auth.uid == request.resource.data.ownerId;
        allow update: if isSignedIn() && (isOwner() || isParticipant());
        allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Secure messages within group chats.
     * @path /groups/{groupId}/messages/{messageId}
     * @allow (get, list) Users can read messages in group chats they participate in.
     * @allow (create) Users can create messages in group chats they participate in.
     * @deny (get, list, create, update, delete) Users cannot access messages in group chats they are not a participant in.
     * @principle Enforces access based on group membership.
     */
    match /groups/{groupId}/messages/{messageId} {
        function isSignedIn() {
            return request.auth != null;
        }
        function isGroupParticipant(groupId) {
            return get(/databases/$(database)/documents/groups/$(groupId)).data.participants[request.auth.uid] == true;
        }

        allow get: if isSignedIn() && isGroupParticipant(groupId);
        allow list: if isSignedIn() && isGroupParticipant(groupId);
        allow create: if isSignedIn() && isGroupParticipant(groupId);
        allow update: if false;
        allow delete: if false;
    }
    /**
     * @description Administrative page for managing team members.
     * @path /admin/team
     * @allow (get, list) Public read access for team member profiles.
     * @deny (create, update, delete) Only authenticated users can create, update, or delete team member profiles.
     * @principle Provides public information while restricting modification.
     */
        match /admin/team/{document} {
            function isSignedIn() {
                return request.auth != null;
            }

            allow get, list: if true;
            allow create: if isSignedIn();
            allow update: if isSignedIn();
            allow delete: if isSignedIn();
        }
  }
}