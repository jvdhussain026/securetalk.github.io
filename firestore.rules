/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a user-centric security model for the Secure Talk application.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information, accessible only to the user themselves.
 * - /chats/{chatId}: Stores chat session data. Access is controlled by the 'participants' map within the chat document.
 * - /chats/{chatId}/messages/{messageId}: Stores messages within a chat. Access is controlled by the 'participants' map in the parent chat document.
 * - /users/{userId}/contacts/{contactId}: Stores contact information for a user, accessible only to the user.
 *
 * Key Security Decisions:
 * - Users can only access their own user document and associated subcollections (contacts).
 * - Chat access is granted to participants listed in the 'participants' map of a chat document.
 * - Messages inherit the access control of their parent chat document.
 *
 * Denormalization for Authorization:
 * - The `participants` map is denormalized onto the `/chats/{chatId}` documents to enable efficient access control for chats and messages.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (create) - User can create their own profile if the userId matches their auth.uid.
     * @allow (get, update, delete) - User can only access their own profile.
     * @deny (create) - User cannot create a profile with an ID that doesn't match their auth.uid.
     * @deny (get, update, delete) - User cannot access another user's profile.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to a user's contacts.
     * @path /users/{userId}/contacts/{contactId}
     * @allow (create) - User can create a contact if the userId matches their auth.uid.
     * @allow (get, list, update, delete) - User can only access their own contacts.
     * @deny (create) - User cannot create a contact under another user's profile.
     * @deny (get, list, update, delete) - User cannot access another user's contacts.
     * @principle Enforces document ownership for contacts.
     */
    match /users/{userId}/contacts/{contactId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to chat sessions.
     * @path /chats/{chatId}
     * @allow (get, list) - Only participants can read chat details.
     * @allow (create) - Only authenticated users can create chats and they must be a participant.
     * @allow (update, delete) - Only participants can modify chat details.
     * @deny (create) - Non-authenticated users cannot create chats.
     * @deny (get, list, update, delete) - Non-participants cannot access chat details.
     * @principle Enforces shared access based on chat participants.
     */
    match /chats/{chatId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isParticipant(chatId) {
        return get(/databases/$(database)/documents/chats/$(chatId)).data.participants[request.auth.uid] == true;
      }

      function isCreatingParticipant() {
        return request.resource.data.participants[request.auth.uid] == true;
      }

      allow get: if isSignedIn() && isParticipant(chatId);
      allow list: if false;
      allow create: if isSignedIn() && isCreatingParticipant();
      allow update: if isSignedIn() && isParticipant(chatId);
      allow delete: if isSignedIn() && isParticipant(chatId);
    }

    /**
     * @description Controls access to messages within a chat session.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (get, list) - Only participants of the chat can read messages.
     * @allow (create) - Only participants of the chat can create messages.
     *                - The 'senderId' field MUST match the authenticated user's UID.
     * @allow (update, delete) - Only participants of the chat can modify or delete messages.
     * @deny (create) - Creating a message with a mismatched 'senderId' or by a non-participant is denied.
     * @deny (get, list, update, delete) - Non-participants cannot access messages.
     * @principle Enforces shared access for messages based on chat participation and validates sender identity.
     */
    match /chats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isChatParticipant(chatId) {
        return get(/databases/$(database)/documents/chats/$(chatId)).data.participants[request.auth.uid] == true;
      }

      function isValidSender() {
        return request.resource.data.senderId == request.auth.uid;
      }
      
      allow get: if isSignedIn() && isChatParticipant(chatId);
      allow list: if isSignedIn() && isChatParticipant(chatId);
      allow create: if isSignedIn() && isChatParticipant(chatId) && isValidSender();
      allow update: if isSignedIn() && isChatParticipant(chatId);
      allow delete: if isSignedIn() && isChatParticipant(chatId);
    }
  }
}