rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces user-ownership for profile data. Users can only read/write their own data.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (get, create, update, delete, list) if the authenticated user's ID matches the user ID in the path.
     * @deny (get) if the authenticated user's ID does not match the user ID in the path.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Restricts access to usernames.
     * @path /databases/{database}/documents/usernames/{username}
     * @allow (get) any authenticated user can read the username mappings.
     * @deny (create, update, delete, list) only the backend (server) should be able to modify usernames.
     * @principle Centralized username management.
     */
    match /usernames/{username} {
        allow get: if isSignedIn();
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }

    /**
     * @description Allows public read access to team member profiles, restricts writes.
     * @path /databases/{database}/documents/team/{userId}
     * @allow (get, list) any user can read the list of team members.
     * @deny (create, update, delete) team member management is handled via backend.
     * @principle Public read access with restricted writes.
     */
    match /team/{userId} {
        allow get: if true;
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }

    /**
     * @description Enforces shared access for chat sessions. Participants can read/write.
     * @path /databases/{database}/documents/chats/{chatId}
     * @allow (get, create, update, delete, list) if the authenticated user is a participant in the chat.
     * @principle Shared access based on participants list.
     */
    match /chats/{chatId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isParticipant() {
        return isSignedIn() && request.auth.uid in resource.data.participants;
      }

      allow get: if isParticipant();
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.participants[request.auth.uid] == true;
      allow update: if isParticipant();
      allow delete: if isParticipant();

      /**
       * @description Enforces shared access for chat messages within a chat session. Participants can read/write.
       * @path /databases/{database}/documents/chats/{chatId}/messages/{messageId}
       * @allow (get, create, update, delete, list) if the authenticated user is a participant in the chat.
       */
      match /messages/{messageId} {
        allow get: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants[request.auth.uid] == true;
        allow list: if false;
        allow create: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants[request.auth.uid] == true;
        allow update: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants[request.auth.uid] == true;
        allow delete: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants[request.auth.uid] == true;
      }
    }

    /**
     * @description Enforces user-ownership for contact lists. Users can only read/write their own contacts.
     * @path /databases/{database}/documents/users/{userId}/contacts/{contactId}
     * @allow (get, create, update, delete, list) if the authenticated user's ID matches the user ID in the path.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/contacts/{contactId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces shared access for group chat sessions. Participants can read/write.
     * @path /databases/{database}/documents/groups/{groupId}
     * @allow (get, create, update, delete, list) if the authenticated user is a participant in the group.
     * @principle Shared access based on participants list.
     */
    match /groups/{groupId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isParticipant() {
        return isSignedIn() && request.auth.uid in resource.data.participants;
      }

      allow get: if isParticipant();
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.participants[request.auth.uid] == true;
      allow update: if isParticipant();
      allow delete: if isParticipant();

      /**
       * @description Enforces shared access for group messages within a group chat session. Participants can read/write.
       * @path /databases/{database}/documents/groups/{groupId}/messages/{messageId}
       * @allow (get, create, update, delete, list) if the authenticated user is a participant in the group.
       */
      match /messages/{messageId} {
        allow get: if isSignedIn() && get(/databases/$(database)/documents/groups/$(groupId)).data.participants[request.auth.uid] == true;
        allow list: if false;
        allow create: if isSignedIn() && get(/databases/$(database)/documents/groups/$(groupId)).data.participants[request.auth.uid] == true;
        allow update: if isSignedIn() && get(/databases/$(database)/documents/groups/$(groupId)).data.participants[request.auth.uid] == true;
        allow delete: if isSignedIn() && get(/databases/$(database)/documents/groups/$(groupId)).data.participants[request.auth.uid] == true;
      }
    }
    
    /**
     * @description Denies all access to the /admin/team collection, managed by backend.
     * @path /databases/{database}/documents/admin/team
     * @allow (get, create, update, delete, list) never.
     * @principle Backend-only management of team member data.
     */
    match /admin/team {
        allow get: if false;
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }
  }
}