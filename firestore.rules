/**
 * @fileOverview Firestore Security Rules for the Secure Talk application.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles and contacts,
 * and a shared-access model for chats and messages. It prioritizes security by
 * default, requiring explicit authorization for all read and write operations.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information, accessible only by the user themselves.
 * - /chats/{chatId}: Stores chat session information, accessible to chat participants.
 * - /chats/{chatId}/messages/{messageId}: Stores messages within a chat session, accessible to chat participants.
 * - /users/{userId}/contacts/{contactId}: Stores contact information for a user, accessible only by the user.
 *
 * Key Security Decisions:
 * - User data is strictly private and only accessible to the owning user.
 * - Chat data is shared between participants.
 * - Contacts are private to the user.
 * - Data validation is limited to relational integrity and ownership checks to allow for rapid prototyping.
 *
 * Denormalization for Authorization:
 * - Chats:  The 'participants' array is denormalized on the chat document to easily check user access.
 * - Messages: The 'chatId' field is denormalized on the message document to allow efficient querying and authorization.
 * - Contacts: The 'userId' field is denormalized on the contact document to enforce ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (get) User with matching userId can read their own profile.
     * @allow (create) User can create their own profile if the userId matches their auth.uid.
     * @allow (update) User with matching userId can update their own profile.
     * @allow (delete) User with matching userId can delete their own profile.
     * @deny (get) User cannot read another user's profile.
     * @deny (create) User cannot create a profile with a userId that doesn't match their auth.uid.
     * @deny (update) User cannot update another user's profile.
     * @deny (delete) User cannot delete another user's profile.
     * @principle Enforces document ownership for writes and restricts access to a user's own data.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to chat session information.
     * @path /databases/{database}/documents/chats/{chatId}
     * @allow (get) User who is a participant in the chat can read the chat.
     * @allow (list) No listing of chats.
     * @allow (create) User who is a participant in the chat can create the chat.
     * @allow (update) User who is a participant in the chat can update the chat.
     * @allow (delete) No deleting of chats.
     * @deny (get) User who is not a participant in the chat cannot read the chat.
     * @deny (create) User who is not a participant in the chat cannot create the chat.
     * @deny (update) User who is not a participant in the chat cannot update the chat.
     * @deny (delete) User cannot delete the chat.
     * @principle Enforces shared access based on chat participants.
     */
    match /chats/{chatId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isParticipant() {
        return isSignedIn() && resource.data.participants.hasAny([request.auth.uid]);
      }

      allow get: if isParticipant();
      allow list: if false;

      allow create: if isSignedIn() && request.resource.data.participants.hasAny([request.auth.uid]);
      allow update: if isParticipant();
      allow delete: if false;
    }

    /**
     * @description Controls access to messages within a chat session.
     * @path /databases/{database}/documents/chats/{chatId}/messages/{messageId}
     * @allow (get) User who is a participant in the chat can read the message.
     * @allow (list) No listing of messages.
     * @allow (create) User who is a participant in the chat can create the message.
     * @allow (update) No updating of messages.
     * @allow (delete) No deleting of messages.
     * @deny (get) User who is not a participant in the chat cannot read the message.
     * @deny (create) User who is not a participant in the chat cannot create the message.
     * @deny (update) All updates are denied.
     * @deny (delete) All deletes are denied.
     * @principle Enforces shared access based on chat participants and prevents modification of messages.
     */
    match /chats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isParticipant(chatId) {
        return isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      }

      allow get: if isParticipant(chatId);
      allow list: if false;

      allow create: if isParticipant(chatId) && request.resource.data.chatId == chatId;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to contact information for a user.
     * @path /databases/{database}/documents/users/{userId}/contacts/{contactId}
     * @allow (get) User with matching userId can read their own contacts.
     * @allow (list) User with matching userId can list their own contacts.
     * @allow (create) User with matching userId can create contacts.
     * @allow (update) User with matching userId can update their own contacts.
     * @allow (delete) User with matching userId can delete their own contacts.
     * @deny (get) User cannot read another user's contacts.
     * @deny (create) User cannot create a contact with a userId that doesn't match their auth.uid.
     * @deny (update) User cannot update another user's contacts.
     * @deny (delete) User cannot delete another user's contacts.
     * @principle Enforces document ownership for writes and restricts access to a user's own data.
     */
    match /users/{userId}/contacts/{contactId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}