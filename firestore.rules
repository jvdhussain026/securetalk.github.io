/**
 * @fileoverview
 * Firestore Security Rules for Secure Talk application.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles and contacts,
 * shared access for chats and groups, and public read access for team members.
 *
 * Data Structure:
 * - /users/{userId}: User profile information, accessible only by the user.
 * - /usernames/{username}: Stores unique usernames, publicly readable.
 * - /team/{userId}: Team member profiles, publicly readable, but write access is unclear.
 * - /chats/{chatId}: Chat sessions between users, accessible to participants.
 * - /chats/{chatId}/messages/{messageId}: Messages within a chat, accessible to participants.
 * - /users/{userId}/contacts/{contactId}: User's contacts, accessible only by the user.
 * - /groups/{groupId}: Group chat information, accessible to participants.
 * - /groups/{groupId}/messages/{messageId}: Messages within a group chat, accessible to participants.
 *
 * Key Security Decisions:
 * - Users can only read/write their own profile and contacts.
 * - Chats and groups are accessible to authorized participants.
 * - Team member profiles are publicly readable.
 * - User listing is disallowed to protect privacy.
 *
 * Denormalization for Authorization:
 * - Chats and Groups: The `participants` map is used to authorize access, avoiding the need for separate membership documents.
 *
 * Structural Segregation:
 * - No explicit segregation between public and private data is used.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create their own profile at /users/user123.
     * @allow (get) - User with UID 'user123' can read their profile at /users/user123.
     * @allow (update) - User with UID 'user123' can update their profile at /users/user123.
     * @allow (delete) - User with UID 'user123' can delete their profile at /users/user123.
     * @deny (create) - User with UID 'user456' cannot create a profile at /users/user123.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Controls access to reserved usernames.
     * @path /usernames/{username}
     * @allow (get) - Any signed-in user can read a username.
     * @allow (list) - Listing usernames is denied.
     * @deny (create) - No one can create usernames directly; they are created via a backend function.
     * @deny (update) - No one can update usernames directly; they are managed by a backend function.
     * @deny (delete) - No one can delete usernames directly; they are managed by a backend function.
     * @principle Restricts username creation/modification to backend.
     */
    match /usernames/{username} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

     /**
      * @description Controls access to team member profiles.
      * @path /team/{userId}
      * @allow (get) - Any signed-in user can read team member profiles.
      * @allow (list) - Any signed-in user can list team member profiles.
      * @deny (create) - No one can create team member profiles through the client.
      * @deny (update) - No one can update team member profiles through the client.
      * @deny (delete) - No one can delete team member profiles through the client.
      * @principle Public read access for team members, restricted write access.
      */
    match /team/{userId} {
      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to chat sessions.
     * @path /chats/{chatId}
     * @allow (get) - User with UID 'user123' can read chat 'chat456' if they are a participant.
     * @allow (create) - User with UID 'user123' can create a chat.
     * @allow (update) - User with UID 'user123' can update a chat if they are a participant.
     * @allow (delete) - User with UID 'user123' can delete a chat if they are a participant.
     * @deny (get) - User with UID 'user789' cannot read chat 'chat456' if they are not a participant.
     * @principle Grants access to chat participants.
     */
    match /chats/{chatId} {
      allow get: if isSignedIn() && isParticipant(resource.data.participants);
      allow list: if false;
      allow create: if isSignedIn() ;
      allow update: if isSignedIn() && isParticipant(resource.data.participants);
      allow delete: if isSignedIn() && isParticipant(resource.data.participants);
    }

    /**
     * @description Controls access to messages within a chat session.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (get) - User with UID 'user123' can read message 'message789' in chat 'chat456' if they are a participant.
     * @allow (create) - User with UID 'user123' can create message 'message789' in chat 'chat456' if they are a participant.
     * @allow (update) - User with UID 'user123' can update message 'message789' in chat 'chat456' if they are a participant.
     * @allow (delete) - User with UID 'user123' can delete message 'message789' in chat 'chat456' if they are a participant.
     * @deny (get) - User with UID 'user789' cannot read message 'message789' in chat 'chat456' if they are not a participant.
     * @principle Grants access to chat participants.
     */
    match /chats/{chatId}/messages/{messageId} {
      allow get: if isSignedIn() && isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
      allow list: if isSignedIn() && isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
      allow create: if isSignedIn() && isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
      allow update: if isSignedIn() && isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
      allow delete: if isSignedIn() && isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
    }

    /**
     * @description Controls access to a user's contacts.
     * @path /users/{userId}/contacts/{contactId}
     * @allow (create) - User with UID 'user123' can create a contact at /users/user123/contacts/contact456.
     * @allow (get) - User with UID 'user123' can read their contact at /users/user123/contacts/contact456.
     * @allow (update) - User with UID 'user123' can update their contact at /users/user123/contacts/contact456.
     * @allow (delete) - User with UID 'user123' can delete their contact at /users/user123/contacts/contact456.
     * @deny (create) - User with UID 'user456' cannot create a contact at /users/user123/contacts/contact456.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/contacts/{contactId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

     /**
      * @description Controls access to group chat information.
      * @path /groups/{groupId}
      * @allow (get) - User with UID 'user123' can read group 'group456' if they are a participant.
      * @allow (create) - User with UID 'user123' can create a group.
      * @allow (update) - User with UID 'user123' can update a group if they are a participant.
      * @allow (delete) - User with UID 'user123' can delete a group if they are a participant.
      * @deny (get) - User with UID 'user789' cannot read group 'group456' if they are not a participant.
      * @principle Grants access to group participants.
      */
    match /groups/{groupId} {
      allow get: if isSignedIn() && isParticipant(resource.data.participants);
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && isParticipant(resource.data.participants);
      allow delete: if isSignedIn() && isParticipant(resource.data.participants);
    }

    /**
     * @description Controls access to messages within a group chat session.
     * @path /groups/{groupId}/messages/{messageId}
     * @allow (get) - User with UID 'user123' can read message 'message789' in group 'group456' if they are a participant.
     * @allow (create) - User with UID 'user123' can create message 'message789' in group 'group456' if they are a participant.
     * @allow (update) - User with UID 'user123' can update message 'message789' in group 'group456' if they are a participant.
     * @allow (delete) - User with UID 'user123' can delete message 'message789' in group 'group456' if they are a participant.
     * @deny (get) - User with UID 'user789' cannot read message 'message789' in group 'group456' if they are not a participant.
     * @principle Grants access to group participants.
     */
    match /groups/{groupId}/messages/{messageId} {
      allow get: if isSignedIn() && isParticipant(get(/databases/$(database)/documents/groups/$(groupId)).data.participants);
      allow list: if isSignedIn() && isParticipant(get(/databases/$(database)/documents/groups/$(groupId)).data.participants);
      allow create: if isSignedIn() && isParticipant(get(/databases/$(database)/documents/groups/$(groupId)).data.participants);
      allow update: if isSignedIn() && isParticipant(get(/databases/$(database)/documents/groups/$(groupId)).data.participants);
      allow delete: if isSignedIn() && isParticipant(get(/databases/$(database)/documents/groups/$(groupId)).data.participants);
    }
    
    /**
     * @description Controls access to team member management via /admin/team.
     * @path /admin/team
     * @deny (get) - Listing or getting team members isn't possible via this path, deny all access.
     * @deny (create) - Creating new team members isn't possible via this path, deny all access.
     * @deny (update) - Updating team members isn't possible via this path, deny all access.
     * @deny (delete) - Deleting team members isn't possible via this path, deny all access.
     */
    match /admin/team {
        allow get: if false;
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }

  }

  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }

  function isParticipant(participants) {
    return participants[request.auth.uid] == true;
  }
}