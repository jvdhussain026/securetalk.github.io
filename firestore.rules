/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for most data,
 *              with shared access for chats and groups. Data shape validation is relaxed
 *              to allow for rapid prototyping.
 *
 * @dataStructure
 *  - /users/{userId}: Stores user profile information, accessible only to the user.
 *  - /usernames/{username}: Stores a mapping of usernames to user IDs.
 *  - /team/{userId}: Stores team member profiles, publicly readable.
 *  - /chats/{chatId}: Stores 1-on-1 chat session information, accessible to participants.
 *  - /chats/{chatId}/messages/{messageId}: Stores messages within a 1-on-1 chat, accessible to participants.
 *  - /users/{userId}/contacts/{contactId}: Stores contact information for a user, accessible only to the user.
 *  - /groups/{groupId}: Stores group chat information, accessible to group members.
 *  - /groups/{groupId}/messages/{messageId}: Stores messages within a group chat, accessible to group members.
 *  - /admin/team: Stores profiles of team members to be shown on the About Us page.
 *
 * @keySecurityDecisions
 *  - User listing is disallowed to prevent scraping.
 *  - Public read access is granted to the /team collection.
 *  - Chats and Groups implement shared access based on the `participants` map.
 *
 * @denormalizationForAuthorization
 *  - Chats and Groups require a `participants` map on the document to authorize access to the chat and its messages.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles, accessible only to the authenticated user.
     * @path /users/{userId}
     * @allow (get) User with ID 'user_abc' can read their profile data.
     *    - auth.uid: 'user_abc'
     * @allow (create) User with ID 'user_abc' can create their profile.
     *    - auth.uid: 'user_abc'
     *    - request.resource.data.id: 'user_abc'
     * @allow (update) User with ID 'user_abc' can update their profile.
     *    - auth.uid: 'user_abc'
     * @allow (delete) User with ID 'user_abc' can delete their profile.
     *    - auth.uid: 'user_abc'
     * @deny (get) User with ID 'user_xyz' cannot read User 'user_abc' profile data.
     *    - auth.uid: 'user_xyz'
     * @deny (create) User with ID 'user_xyz' cannot create User 'user_abc' profile.
     *    - auth.uid: 'user_xyz'
     *    - request.resource.data.id: 'user_abc'
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.get('id', '') == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Secure usernames, ensuring only the associated user can manage them.
     * @path /usernames/{username}
     * @allow (create) User with UID 'user_abc' can create a username entry if they own it.
     *    - auth.uid: 'user_abc'
     *    - request.resource.data.uid: 'user_abc'
     * @allow (get) User with UID 'user_abc' can read a username if they own it.
     *    - auth.uid: 'user_abc'
     * @allow (update) User with UID 'user_abc' can update a username if they own it.
     *    - auth.uid: 'user_abc'
     * @allow (delete) User with UID 'user_abc' can delete a username if they own it.
     * @deny (create) User with UID 'user_xyz' cannot create a username if they do not own it.
     *    - auth.uid: 'user_xyz'
     *    - request.resource.data.uid: 'user_abc'
     * @principle Enforces ownership of usernames to prevent hijacking.
     */
    match /usernames/{username} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwnerByUid(uid) {
        return request.auth.uid == uid;
      }

      function isExistingOwnerByUid(uid) {
        return isOwnerByUid(uid) && resource != null;
      }

      allow get: if isSignedIn() && resource.data.get('uid', '') == request.auth.uid;
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.get('uid', '') == request.auth.uid;
      allow update: if isSignedIn() && resource.data.get('uid', '') == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.get('uid', '') == request.auth.uid;
    }

    /**
     * @description Allow public read access to team member profiles.
     * @path /team/{userId}
     * @allow (get) Any user can read team member profiles.
     * @allow (list) Any user can list team member profiles.
     * @deny (create) No one can create team member profiles through the client.
     * @deny (update) No one can update team member profiles through the client.
     * @deny (delete) No one can delete team member profiles through the client.
     * @principle Provides public information about team members.
     */
    match /team/{userId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Secure 1-on-1 chats, accessible only to participating users.
     * @path /chats/{chatId}
     * @allow (get) User 'user_abc' can read the chat if they are a participant.
     *    - auth.uid: 'user_abc'
     *    - resource.data.participants: {'user_abc': true, 'user_xyz': true}
     * @allow (create) User 'user_abc' can create a new chat if they are a participant.
     *    - auth.uid: 'user_abc'
     *    - request.resource.data.participants: {'user_abc': true, 'user_xyz': true}
     * @allow (update) User 'user_abc' can update a chat if they are a participant.
     *    - auth.uid: 'user_abc'
     *    - resource.data.participants: {'user_abc': true, 'user_xyz': true}
     * @allow (delete) User 'user_abc' can delete a chat if they are a participant (uncommon).
     *    - auth.uid: 'user_abc'
     *    - resource.data.participants: {'user_abc': true, 'user_xyz': true}
     * @deny (get) User 'user_pqr' cannot read the chat if they are not a participant.
     *    - auth.uid: 'user_pqr'
     *    - resource.data.participants: {'user_abc': true, 'user_xyz': true}
     * @principle Implements shared access based on the 'participants' map.
     */
    match /chats/{chatId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isParticipant() {
        return resource.data.participants[request.auth.uid] == true;
      }

      function isCreatingParticipant() {
        return request.resource.data.participants[request.auth.uid] == true;
      }

      function isExistingParticipant() {
        return resource.data.participants[request.auth.uid] == true && resource != null;
      }

      allow get: if isSignedIn() && isParticipant();
      allow list: if false;
      allow create: if isSignedIn() && isCreatingParticipant();
      allow update: if isSignedIn() && isExistingParticipant();
      allow delete: if isSignedIn() && isExistingParticipant();
    }

    /**
     * @description Secure messages within a 1-on-1 chat, accessible only to chat participants.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (get) User 'user_abc' can read a message if they are a participant in the chat.
     *    - auth.uid: 'user_abc'
     *    - (Chat)/chats/{chatId}.participants: {'user_abc': true, 'user_xyz': true}
     * @allow (create) User 'user_abc' can create a message if they are a participant in the chat.
     *    - auth.uid: 'user_abc'
     *    - (Chat)/chats/{chatId}.participants: {'user_abc': true, 'user_xyz': true}
     * @allow (update) User 'user_abc' can update a message if they are the sender and a participant in the chat.
     *    - auth.uid: 'user_abc'
     *    - resource.data.senderId: 'user_abc'
     *    - (Chat)/chats/{chatId}.participants: {'user_abc': true, 'user_xyz': true}
     * @allow (delete) User 'user_abc' can delete a message if they are the sender and a participant in the chat.
     *    - auth.uid: 'user_abc'
     *    - resource.data.senderId: 'user_abc'
     *    - (Chat)/chats/{chatId}.participants: {'user_abc': true, 'user_xyz': true}
     * @deny (get) User 'user_pqr' cannot read a message if they are not a participant in the chat.
     *    - auth.uid: 'user_pqr'
     *    - (Chat)/chats/{chatId}.participants: {'user_abc': true, 'user_xyz': true}
     * @principle Restricts message access to chat participants.
     */
    match /chats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isChatParticipant(chatId) {
        return get(/databases/$(database)/documents/chats/$(chatId)).data.participants[request.auth.uid] == true;
      }

      function isMessageSender() {
        return resource.data.get('senderId', '') == request.auth.uid;
      }

      function isExistingMessageSender() {
        return resource.data.get('senderId', '') == request.auth.uid && resource != null;
      }

      allow get: if isSignedIn() && isChatParticipant(chatId);
      allow list: if false;
      allow create: if isSignedIn() && isChatParticipant(chatId);
      allow update: if isSignedIn() && isChatParticipant(chatId) && isExistingMessageSender();
      allow delete: if isSignedIn() && isChatParticipant(chatId) && isExistingMessageSender();
    }

    /**
     * @description Secure contact lists, accessible only to the owning user.
     * @path /users/{userId}/contacts/{contactId}
     * @allow (get) User 'user_abc' can read their contact list.
     *    - auth.uid: 'user_abc'
     * @allow (create) User 'user_abc' can create a contact in their list.
     *    - auth.uid: 'user_abc'
     *    - request.resource.data.userId: 'user_abc'
     * @allow (update) User 'user_abc' can update a contact in their list.
     *    - auth.uid: 'user_abc'
     * @allow (delete) User 'user_abc' can delete a contact from their list.
     *    - auth.uid: 'user_abc'
     * @deny (get) User 'user_xyz' cannot read User 'user_abc' contact list.
     *    - auth.uid: 'user_xyz'
     * @principle Enforces document ownership for contact management.
     */
    match /users/{userId}/contacts/{contactId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Secure group chats, accessible only to group members.
     * @path /groups/{groupId}
     * @allow (get) User 'user_abc' can read the group if they are a participant.
     *    - auth.uid: 'user_abc'
     *    - resource.data.participants: {'user_abc': true, 'user_xyz': true}
     * @allow (create) User 'user_abc' can create a new group if they are the owner and a participant.
     *    - auth.uid: 'user_abc'
     *    - request.resource.data.ownerId: 'user_abc'
     *    - request.resource.data.participants: {'user_abc': true, 'user_xyz': true}
     * @allow (update) User 'user_abc' can update a group if they are the owner and a participant.
     *    - auth.uid: 'user_abc'
     *    - resource.data.ownerId: 'user_abc'
     *    - resource.data.participants: {'user_abc': true, 'user_xyz': true}
     * @allow (delete) User 'user_abc' can delete a group if they are the owner.
     *    - auth.uid: 'user_abc'
     *    - resource.data.ownerId: 'user_abc'
     * @deny (get) User 'user_pqr' cannot read the group if they are not a participant.
     *    - auth.uid: 'user_pqr'
     *    - resource.data.participants: {'user_abc': true, 'user_xyz': true}
     * @principle Implements shared access based on the 'participants' map and owner control.
     */
    match /groups/{groupId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isParticipant() {
        return resource.data.participants[request.auth.uid] == true;
      }

      function isOwner(ownerId) {
        return request.auth.uid == ownerId;
      }

      function isCreatingOwner() {
        return request.resource.data.get('ownerId', '') == request.auth.uid;
      }

      function isExistingOwner() {
        return resource.data.get('ownerId', '') == request.auth.uid && resource != null;
      }

      function isOwnerAndParticipant() {
          return isParticipant() && isOwner(resource.data.get('ownerId', ''));
      }

      function isExistingOwnerAndParticipant() {
        return isParticipant() && isExistingOwner();
      }

      allow get: if isSignedIn() && isParticipant();
      allow list: if false;
      allow create: if isSignedIn() && isCreatingOwner() && request.resource.data.participants[request.auth.uid] == true;
      allow update: if isSignedIn() && isExistingOwnerAndParticipant();
      allow delete: if isSignedIn() && isExistingOwner();
    }

    /**
     * @description Secure messages within a group chat, accessible only to group members.
     * @path /groups/{groupId}/messages/{messageId}
     * @allow (get) User 'user_abc' can read a message if they are a participant in the group.
     *    - auth.uid: 'user_abc'
     *    - (Group)/groups/{groupId}.participants: {'user_abc': true, 'user_xyz': true}
     * @allow (create) User 'user_abc' can create a message if they are a participant in the group.
     *    - auth.uid: 'user_abc'
     *    - (Group)/groups/{groupId}.participants: {'user_abc': true, 'user_xyz': true}
     * @allow (update) User 'user_abc' can update a message if they are the sender and a participant in the group.
     *    - auth.uid: 'user_abc'
     *    - resource.data.senderId: 'user_abc'
     *    - (Group)/groups/{groupId}.participants: {'user_abc': true, 'user_xyz': true}
     * @allow (delete) User 'user_abc' can delete a message if they are the sender and a participant in the group.
     *    - auth.uid: 'user_abc'
     *    - resource.data.senderId: 'user_abc'
     *    - (Group)/groups/{groupId}.participants: {'user_abc': true, 'user_xyz': true}
     * @deny (get) User 'user_pqr' cannot read a message if they are not a participant in the group.
     *    - auth.uid: 'user_pqr'
     *    - (Group)/groups/{groupId}.participants: {'user_abc': true, 'user_xyz': true}
     * @principle Restricts message access to group participants.
     */
    match /groups/{groupId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isGroupParticipant(groupId) {
        return get(/databases/$(database)/documents/groups/$(groupId)).data.participants[request.auth.uid] == true;
      }

      function isMessageSender() {
        return resource.data.get('senderId', '') == request.auth.uid;
      }

      function isExistingMessageSender() {
        return resource.data.get('senderId', '') == request.auth.uid && resource != null;
      }

      allow get: if isSignedIn() && isGroupParticipant(groupId);
      allow list: if false;
      allow create: if isSignedIn() && isGroupParticipant(groupId);
      allow update: if isSignedIn() && isGroupParticipant(groupId) && isExistingMessageSender();
      allow delete: if isSignedIn() && isGroupParticipant(groupId) && isExistingMessageSender();
    }

    /**
     * @description Team members can be managed under the admin section
     * @path /admin/team
     * @allow (get) Not allowed.
     * @allow (list) Not allowed.
     * @deny (create) Not allowed.
     * @deny (update) Not allowed.
     * @deny (delete) Not allowed.
     */
     match /admin/team {
        allow get: if false;
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
     }
  }
}